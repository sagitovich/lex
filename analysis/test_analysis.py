import pickle
import string
import pymorphy3

from nltk.corpus import stopwords
from nltk.stem import SnowballStemmer
from nltk.tokenize import word_tokenize
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.metrics.pairwise import cosine_similarity


# nltk.download('stopwords')
# nltk.download('punkt')


class FilterMachine:
    context_dicts = {
        "extremist": {"радикал", "экстремист", "насилие", "пропаганда",
                      "возмущение", "бунт", "замысел", "подстрекательство",
                      "ненависть", "дестабилизация", "агрессия", "революция",
                      "фанатизм", "идеология", "секта", "дискриминация",
                      "интолерантность", "маргинализация", "радикализация",
                      "провокация", "эскалация", "конфликт", "оппозиция",
                      "резистенция", "сопротивление"},

        "terrorist": {"террорист", "бомба", "атака", "угроза", "взрыв",
                      "атака", "радикал", "заложник", "террор", "бомба",
                      "разрушение", "вторжение", "шантаж", "саботаж",
                      "мошенничество", "радикал", "экстремист", "идеология",
                      "подстрекательство", "пропаганда", "рекрут", "инсургент",
                      "джихад", "мартир", "смертник", "фундаментализм",
                      "экстремизм", "вооруженный", "конфликт", "безопасность"},

        "dangerous": {"опасный", "риск", "угроза", "опасность", "злоумышление",
                      "предупреждение", "вред", "небезопасно", "тревога",
                      "осторожность", "экстренная ситуация", "авария",
                      "катастрофа", "паника", "бедствие", "чрезвычайное происшествие",
                      "замысел", "преступление", "нарушение", "враждебность",
                      "нападение", "вторжение", "шантаж", "террор",
                      "саботаж", "мошенничество", "подозрительный",
                      "недобросовестность", "противозаконный", "нелегальный"},

        "suicide": {"отчаяние", "безысходность", "самоубийство",
                    "покончить жизнь самоубийством", "боль", "тоска",
                    "безнадежность", "страдание", "депрессия", "тревога",
                    "психологическая помощь", "профилактика суицида", "саморазрушение",
                    "самоповреждение", "отчуждение", "изоляция", "надежда",
                    "поддержка", "терапия", "вмешательство", "кризис"},

        "discrimination": {"расизм", "сексизм", "гомофобия", "трансфобия",
                           "ксенофобия", "антисемитизм", "исламофобия",
                           "нацизм", "фашизм", "шовинизм", "национализм",
                           "сепаратизм", "апартеид", "сегрегация", "изоляция",
                           "стереотип", "предрассудок", "нетерпимость",
                           "неравенство", "несправедливость", "угнетение",
                           "притеснение", "оскорбление", "унижение",
                           "пренебрежение", "игнорирование", "отторжение",
                           "исключение", "лишение", "ограничение",
                           "запрет", "бойкот", "протест", "жалоба",
                           "суд", "право", "защита", "борьба",
                           "солидарность", "толерантность", "уважение",
                           "признание", "интеграция", "включение",
                           "равенство", "справедливость", "свобода",
                           "достоинство", "гуманизм", "демократия"},

        "threat of harm": {"применение насилия", "физическое насилие", "акт насилия",
                           "психологическое насилие", "прямое насилие", "жестокость",
                           "зависимость", "обидчивость", "злоба", "ненависть",
                           "агрессия", "провокация", "эскалация", "конфликт",
                           "оппозиция", "резистенция", "сопротивление", "возмущение",
                           "бунт", "замысел", "подстрекательство", "притеснение",
                           "оскорбление", "унижение", "страх", "защита",
                           "протест", "жалоба", "суд", "право"},

        "violation of law and rules": {"нарушение", "закон", "правило", "норма",
                                       "предписание", "регистрация", "лицензия",
                                       "договор", "цена", "стоимость", "доход",
                                       "прибыль", "налог", "штраф", "санкция",
                                       "ответственность", "административная",
                                       "уголовная", "гражданская", "доказательство",
                                       "проверка", "надзор", "контроль"},

        "authorities and state": {"орган", "власть", "государство", "суд",
                                  "жалоба", "заявление", "иск", "претензия",
                                  "прокуратура", "налоговая", "федеральная",
                                  "служба", "роспотребнадзор", "фас", "мвд", "фсб", "скр"},

        "media and journalism": {"сми", "журналист", "расследование",
                                 "репортаж", "скандал", "афера"},

        "fraud and corruption": {"мошенничество", "коррупция", "взятка", "откат",
                                 "кидалово", "обман", "развод", "подстава",
                                 "подлог", "фальсификация", "плагиат"},

        "crimes and violence": {"кража", "грабеж", "разбой", "убийство", "похищение",
                                "изнасилование", "насилие", "угроза",
                                "прессинг", "шантаж", "эксторсион", "запугивание", "нападение"},

        "insult and humiliation": {"оскорбление", "унижение", "притеснение", "дискриминация",
                                   "расизм", "сексизм", "гомофобия", "трансфобия", "ксенофобия",
                                   "антисемитизм", "исламофобия", "нацизм", "фашизм", "шовинизм",
                                   "национализм", "сепаратизм", "апартеид", "сегрегация",
                                   "изоляция", "стереотип", "предрассудок", "нетерпимость",
                                   "неравенство", "несправедливость", "угнетение"},

        "poverty and unemployment": {"бедность", "безработица", "безнадежность",
                                     "отчаяние"},

        "anger and outrage": {"гнев", "злость", "негодование", "возмущение",
                              "протест", "бунт", "революция", "саботаж",
                              "терроризм", "экстремизм", "радикализм", "фанатизм"},

        "ideology and sectarianism": {"идеология", "секта", "культ", "зомбирование",
                                      "манипуляция", "пропаганда", "агитация", "влияние", "интерес"},

        "protection and struggle": {"защита", "борьба", "сопротивление", "солидарность",
                                    "толерантность", "уважение", "признание", "интеграция",
                                    "включение", "равенство", "справедливость", "свобода",
                                    "достоинство", "гуманизм", "демократия"}
    }

    def __init__(self):
        self.vectorizer = TfidfVectorizer()
        self.stemmer = SnowballStemmer("russian")
        self.stop_words = set(stopwords.words('russian'))
        self.morph = pymorphy3.MorphAnalyzer()

    # Метод для предобработки текста
    def preprocess_text(self, text):
        text = text.lower()
        text = text.translate(str.maketrans('', '', string.punctuation))
        words = word_tokenize(text)

        words = [self.morph.parse(word)[0].normal_form for word in words if word not in self.stop_words]
        return ' '.join(words)

    # Метод для фильтрации комментариев на основе контекстных словарей
    def filter(self, text_list):
        filteredTextList = []
        for text in text_list:
            text = self.preprocess_text(text)

            for topic, context_dict in self.context_dicts.items():
                tfidf_matrix = self.vectorizer.fit_transform([' '.join(context_dict), text])
                similarity = cosine_similarity(tfidf_matrix[0:1], tfidf_matrix[1:2])
                if similarity[0][0] > 0.002:
                    filteredTextList.append(text)
                    break

        return filteredTextList

    def save_model(self, filename):
        # Открываем файл в режиме записи бинарных данных
        with open(filename, 'wb') as f:
            # Используем pickle для сохранения машины в файл
            pickle.dump(self, f)

    @staticmethod
    def load_model(filename):
        # Открываем файл в режиме чтения бинарных данных
        with open(filename, 'rb') as f:
            # Используем pickle для загрузки машины из файла
            return pickle.load(f)


machine = FilterMachine()

receivedText = ['Злость, ненависть, бунт', 'Мне нравятся котики и убийства', 'Я бы хотела завести домашнего питомца',
                'Здесь не место пропаганде!', 'Лучше бы ты сдох', 'Я чувствую пустоту внутри себя',
                'Это очень светлое место! Мне тут нравится', 'У женщин нет прав', 'Этот мир прогнил, я его уничтожу']
filteredReceivedText = machine.filter(receivedText)
print(filteredReceivedText)

machine.save_model('machine.pkl')

# loaded_machine = CommentFilterMachine.load_model('machine.pkl')

'''
# # Импортируем класс CommentFilterMachine из файла, где он определен
# from your_file import CommentFilterMachine
#
# # Загружаем модель из файла
# machine = CommentFilterMachine.load_model('machine.pkl')
#
# # Здесь у вас будет список комментариев, которые вы хотите отфильтровать
# comments = ["Это комментарий о рецептах.", "Это комментарий о любви.", "Это комментарий о политике."]
#
# # Используем модель для фильтрации комментариев
# filtered_comments = machine.filter_comments(comments)
#
# # Выводим отфильтрованные комментарии
# print(filtered_comments)
'''

# Угрозы насилия
'''
"Я намерен нанести вред..."
"Мое терпение на исходе..."
"Я не остановлюсь ни перед чем..."
"Я готов идти до конца..."
"Мне все равно, что будет потом..."
'''

# Экстремистские высказывания:
'''
"Только [определенная группа] имеет право..."
"Все, кто не с нами, против нас..."
"Настало время действовать..."
"Мы должны очистить нашу страну..."
"Наша борьба еще не окончена..."
'''

# Информация о незаконной деятельности:
'''
"Я знаю, как обойти систему..."
"У меня есть план..."
"Я могу получить то, что нам нужно..."
"У меня есть все необходимые инструменты..."
"Я знаю, как это сделать..."
'''

# Дискриминация или ненависть:
'''
"Все они одинаковы..."
"Они не заслуживают уважения..."
"Они всегда были проблемой..."
"Они никогда не смогут быть как мы..."
"Они не имеют места здесь..."
'''

# Разжигание межэтнической розни:
'''
"Мы не можем доверять им..."
"Они всегда были нашими врагами..."
"Они хотят уничтожить нас..."
"Они никогда не смогут жить в мире с нами..."
"Они всегда будут против нас..."
'''
